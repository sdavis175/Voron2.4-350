[gcode_macro START_PRINT]
# For setting the parameters as persistent variables
variable_bed_temp: 0
variable_hotend_temp: 0
variable_chamber_temp: 0
# https://github.com/Frix-x/klipper-voron-V2/blob/main/macros/print_base/print_start.cfg
gcode:
  {% set BED_TEMP = params.BED_TEMP|default(0)|int %}
  {% set HOTEND_TEMP = params.HOTEND_TEMP|default(0)|int %}
  {% set CHAMBER_TEMP = params.CHAMBER_TEMP|default(0)|int %}
  {% set FL_SIZE = params.SIZE|default("0_0_0_0")|string %}
  {% set HEATSOAK_TIME = params.HEATSOAK_TIME|default(8)|int %}
  {% set CHAMBER_MAXTIME = params.CHAMBER_MAXTIME|default(15)|int %}
  {% set MATERIAL = params.MATERIAL|default("XXX")|string %}

  # Set the parameters as persistent variables so they can be referenced outside of the macro (in PRINT_END)
  SET_GCODE_VARIABLE MACRO=START_PRINT VARIABLE=bed_temp VALUE={BED_TEMP}	
  SET_GCODE_VARIABLE MACRO=START_PRINT VARIABLE=hotend_temp VALUE={T_HOTEND}	
  SET_GCODE_VARIABLE MACRO=START_PRINT VARIABLE=chamber_temp VALUE={CHAMBER_TEMP}	

  # 0 Reset everything
  CLEAR_PAUSE
  UPDATE_DELAYED_GCODE ID=EXHAUST_OFF DURATION=0 # Cancel exhaust off timer (if there is one)
  UPDATE_DELAYED_GCODE ID=DELAYED_OFF DURATION=0 # Cancel off timer (if there is one)
  RESET_SPEEDS
  RESET_RGB
  BED_MESH_CLEAR
  G90 # Absolute coordinates
  M83 # Relative Extruder

  # 1 HOMING
  # Home if not already homed and park the head near the center
  CG28
  PARKCENTER

  # 2 BED HEATSOAK
  # Heatsoak the bed if HEATSOAK_TIME is set and bed is not already warming up to the correct temperature (+-8Â°C).
  # We make the assumption that the soak is not needed if the bed is already at the correct target.
  # We also use the nevermore filter under the bed at full power to spread the heat during the heatsoak
  # if a specific temperature need to be reached.
  {% if (HEATSOAK_TIME > 0) and (printer.heater_bed.target < (BED_TEMP - 8)) %}
      # If a specific chamber temperature is needed, we power on the nevermore filter to spread the heat
      # {% if CHAMBER_TEMP > 0 %}
      #     SET_FAN_SPEED FAN=filter SPEED=1
      # {% endif %}
      # Put the bed temperature target and wait for the soak
      HEATSOAK_BED TEMP={BED_TEMP} HEATSOAK_TIME={HEATSOAK_TIME}
  {% else %}  
      # If a specific chamber temperature is needed, we power on the nevermore filter to spread the heat
      # {% if CHAMBER_TEMP > 0 %}
      #     SET_FAN_SPEED FAN=filter SPEED=1
      # {% endif %}      
      # Only heat the bed to the target and continue
      HEATSOAK_BED TEMP={BED_TEMP} HEATSOAK_TIME=0
  {% endif %}

  # 3 CHAMBER HEATSOAK
  # If a setpoint is defined, then we wait to reach the chamber temperature (with a timeout in case it's winter...)
  # We heat up the extruder a little bit to speed up the process. The nevermore filter should also be powered on from the previous step
  {% if CHAMBER_TEMP > 0 %}
      M109 S{HOTEND_TEMP - 50}
      # Wait for the temperature of the chamber to be reached (default max: 15min)
      HEATSOAK_CHAMBER TEMP={CHAMBER_TEMP} MAXTIME={CHAMBER_MAXTIME}
  {% endif %}

  # 4 EXTRUDER HEATING
  # Heat the nozzle to print temperature ontop of the purge bucket
  # and wait 30s to let the nozzle dilate and stabilize
  # G1 X{Px} Y{Py} Z{Pz|int + 20} F{St}
  M109 S{HOTEND_TEMP}
  G4 P{60000 * 0.5}
  {% if V %}
      RESPOND MSG="Extruder temperature OK"
  {% endif %}

  # 5 QUAD GANTRY LEVELING
  {% if printer.quad_gantry_level.applied|lower == 'false' %}
      {% if V %}
          RESPOND MSG="QGL..."
      {% endif %}
      QUAD_GANTRY_LEVEL
  {% endif %}

  # 6 MATERIAL PARAMETERS
  # Material dependant parameters like PA, firmware retraction, Z_offset, etc...
  RESPOND MSG="Material: {MATERIAL}"
  {% if MATERIAL == "PLA" %}
      SET_PRESSURE_ADVANCE ADVANCE=0.0525
  {% elif MATERIAL == "PET" %}
      SET_PRESSURE_ADVANCE ADVANCE=0.0650
      # SET_GCODE_OFFSET Z_ADJUST=0.010 MOVE=1
  {% elif MATERIAL == "ABS" %}
      SET_PRESSURE_ADVANCE ADVANCE=0.0480
      # SET_FAN_SPEED FAN=filter SPEED=0.8
  {% endif %}

  # 7 BED MESH
  {% if V %}
      RESPOND MSG="Bed mesh measurement..."
  {% endif %}
  ADAPTIVE_BED_MESH SIZE={FL_SIZE}

  # 9 ----- PRINT !!! -------------------------------------------
  # Do a prime line, lower the lighs and start the print
  {% if V %}
      RESPOND MSG="Start printing !"
  {% endif %}
  PURGE_LINE
  G92 E0.0

[gcode_macro PURGE_LINE]
gcode:
  G90 # Use absolute coordinates
  G92 E0 # Reset extruder
  G1 Z5.0 F3000 # Move z up little to prevent scratching of surface
  G1 X5 Y5 F5000 # Move to start-line position
  G1 Z0.2 F3000
  G1 X135 Y5 F500 E15  # Draw 1st line
  G1 X135 Y5.4 F5000 # Move to side a little
  G1 X5 Y5.4 F500 E30  # Draw 2nd line
  G92 E0 # Reset extruder
  G1 Z5.0 F3000 # Move z up little to prevent scratching of surface
